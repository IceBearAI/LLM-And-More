<template>
  <BaseBreadcrumb :title="page.title" :breadcrumbs="breadcrumbs"></BaseBreadcrumb>
  <UiParentCard>
    <v-row>
      <v-col cols="12" lg="3" md="4" sm="6">
        <v-text-field
          v-model="searchData.speakName"
          label="请输入标识"
          hide-details
          clearable
          @keyup.enter="doQueryFirstPage"
          @click:clear="doQueryFirstPage"
        ></v-text-field>
      </v-col>
      <v-col cols="12" lg="3" md="4" sm="6">
        <Select
          v-model="searchData.provider"
          :mapDictionary="{ code: 'speak_provider' }"
          label="请选择供应商"
          hide-details
          @change="doQueryFirstPage"
        ></Select>
      </v-col>
      <v-col cols="12" lg="3" md="4" sm="6">
        <Select
          v-model="searchData.lang"
          :mapDictionary="{ code: 'speak_lang' }"
          label="请选择语言"
          hide-details
          @change="doQueryFirstPage"
        ></Select>
      </v-col>
      <v-col cols="12" lg="3" md="4" sm="6">
        <ButtonsInForm>
          <v-btn color="primary" @click="onAdd">添加发声人</v-btn>
        </ButtonsInForm>
      </v-col>
      <v-col cols="12">
        <AlertBlock>修改之后将实时生效，请谨慎操作！</AlertBlock>
      </v-col>

      <v-col cols="12">
        <TableWithPager @query="doTableQuery" ref="tableWithPagerRef" :infos="tableInfos">
          <el-table-column label="标识" width="150px" show-overflow-tooltip>
            <template #default="{ row }">
              <span v-copy="row.speakName">{{ row.speakName }}</span>
            </template>
          </el-table-column>
          <el-table-column label="姓名" prop="speakCname" width="100px"></el-table-column>
          <el-table-column label="供应" width="100px">
            <template #default="{ row }">
              <span>{{ getLabels([["speak_provider", row.provider]]) }} </span>
            </template>
          </el-table-column>
          <el-table-column label="状态" width="100px">
            <template #default="{ row }">
              <ChipStatus v-model="row.enabled"></ChipStatus>
            </template>
          </el-table-column>
          <el-table-column label="语音合成" width="100px">
            <template #default="{ row }">
              <template v-if="row.enabled">
                <router-link
                  :to="{
                    path: '/voice-print/synthesis/synthesis-voice',
                    query: { provider: row.provider, lang: row.lang, speakName: row.speakName }
                  }"
                  class="text-info"
                  >合成</router-link
                >
              </template>
              <template v-else> -- </template>
            </template>
          </el-table-column>
          <el-table-column label="克隆" width="100px">
            <template #default="{ row }">
              <template v-if="row.provider === 'azure-personal'">
                <router-link
                  :to="{
                    path: '/voice-print/synthesis/speaker/clone-detail',
                    query: { speakName: row.speakName }
                  }"
                  class="text-info"
                  >克隆</router-link
                >
              </template>
              <template v-else> -- </template>
            </template>
          </el-table-column>
          <el-table-column label="语言" width="160px">
            <template #default="{ row }">
              <span>
                {{ getLabels([["speak_lang", row.lang]]) }}
              </span>
            </template>
          </el-table-column>
          <el-table-column label="音色" width="120px">
            <template #default="{ row }">
              <div>
                {{
                  getLabels(
                    [
                      ["speak_age_group", row.ageGroup],
                      ["speak_gender", row.gender]
                    ],
                    ret => {
                      if (ret.length) {
                        return ret.join("") + "声";
                      } else {
                        return "未知";
                      }
                    }
                  )
                }}
              </div>
            </template>
          </el-table-column>
          <el-table-column label="试听" min-width="330px">
            <template #default="{ row }">
              <AiAudio :src="row?.speakDemo" />
            </template>
          </el-table-column>
          <el-table-column label="备注" prop="remark" min-width="200px"></el-table-column>
          <el-table-column label="更新时间" min-width="160px">
            <template #default="{ row }">
              {{ format.dateFormat(row.updatedAt, "YYYY-MM-DD HH:mm:ss") }}
            </template>
          </el-table-column>
          <el-table-column label="操作" width="120px" fixed="right">
            <template #default="{ row }">
              <ButtonsInTable :buttons="getButtons(row)" />
            </template>
          </el-table-column>
        </TableWithPager>
      </v-col>
    </v-row>
  </UiParentCard>
  <ConfirmByInput ref="refConfirmDelete" @submit="doDelete">
    <template #text>
      您将要删除<span class="text-primary font-weight-black">{{ confirmDelete.name }}</span
      >发声人，删除之后该声音将无法继续合成新的声音。<br />
      确定要继续吗？
    </template>
  </ConfirmByInput>
  <CreateSpeakerPane ref="createSpeakerPaneRef" @submit="doQueryFirstPage" />
</template>
<script setup lang="ts">
import { reactive, ref, onMounted } from "vue";
import BaseBreadcrumb from "@/components/shared/BaseBreadcrumb.vue";
import UiParentCard from "@/components/shared/UiParentCard.vue";
import AlertBlock from "@/components/ui/AlertBlock.vue";
import ConfirmByInput from "@/components/business/ConfirmByInput.vue";
import AiAudio from "@/components/business/AiAudio.vue";

import CreateSpeakerPane from "./components/CreateSpeakerPane.vue";
import { http, format } from "@/utils";
import { useMapRemoteStore } from "@/stores";
import ChipStatus from "@/components/ui/ChipStatus.vue";

const { loadDictTree, getLabels } = useMapRemoteStore();

loadDictTree(["speak_age_group", "speak_gender", "speak_provider", "speak_lang"]);

const page = ref({ title: "发声人管理" });
const breadcrumbs = ref([
  {
    text: "声音合成",
    disabled: false,
    href: "#"
  },
  {
    text: "发声人管理",
    disabled: true,
    href: "#"
  }
]);
const searchData = reactive({
  speakName: "",
  provider: null,
  lang: null
});
const tableInfos = reactive({
  list: [],
  total: 0
});
const createSpeakerPaneRef = ref();
const tableWithPagerRef = ref();
const refConfirmDelete = ref();
const confirmDelete = reactive({
  id: "",
  name: ""
});

const getButtons = row => {
  let ret = [];
  ret.push({
    text: "删除",
    color: "error",
    click() {
      onDelete(row);
    }
  });
  ret.push({
    text: "编辑",
    color: "info",
    click() {
      onEdit(row);
    }
  });
  return ret;
};

const doTableQuery = async (options = {}) => {
  const [err, res] = await http.get({
    url: "/voice/speak",
    showLoading: tableWithPagerRef.value.el,
    data: {
      ...searchData,
      ...options
    }
  });
  if (res) {
    tableInfos.list = res.list || [];
    tableInfos.total = res.total;
  } else {
    tableInfos.list = [];
    tableInfos.total = 0;
  }
};

const doQueryFirstPage = () => {
  tableWithPagerRef.value.query({ page: 1 });
};

const onDelete = row => {
  confirmDelete.name = row.speakCname;
  confirmDelete.id = row.id;
  refConfirmDelete.value.show({
    width: "400px",
    confirmText: confirmDelete.name
  });
};

const doDelete = async (options = {}) => {
  const [err, res] = await http.delete({
    ...options,
    showSuccess: true,
    url: `/voice/speak/${confirmDelete.id}`
  });
  if (res) {
    refConfirmDelete.value.hide();
    doTableQuery();
  }
};

const onAdd = () => {
  createSpeakerPaneRef.value.show({
    title: "添加发声人",
    operateType: "add"
  });
};

const onEdit = info => {
  createSpeakerPaneRef.value.show({
    title: "编辑发声人",
    infos: info,
    operateType: "edit"
  });
};

onMounted(() => {
  doTableQuery();
});
</script>
