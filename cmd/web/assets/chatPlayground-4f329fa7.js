import{_ as ue}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-4dd6729c.js";import{_ as ce}from"./ConfirmByClick.vue_vue_type_style_index_0_lang-a61f9cf3.js";import{u as de}from"./useScroll-87d0b5f6.js";import{d as K,b7 as me,r as m,x as ie,c as te,k as h,l as z,m as o,j as e,_ as k,Z as I,a6 as W,F as P,$ as H,W as x,b8 as ae,U as pe,X as Z,L as fe,n as J,bo as he,Y as O,bp as _e,am as se,an as oe,a2 as ve,bq as ge,V as ye,aB as xe}from"./utils-8a4540e3.js";import{_ as Ve}from"./ModelSelect.vue_vue_type_script_setup_true_lang-f03aeb00.js";import{a3 as q,a4 as G,V as j,J as le,K as ke,_ as ne,ag as Ce,H as be,h as we,e as Te,$ as $e}from"./index-b4ac7dfa.js";import{V as Q}from"./VSlider-76a20d18.js";import{V as E}from"./VSheet-c9b64548.js";import{M as Ie,S as Se}from"./SendMsg-051f107b.js";import{V as De}from"./VTextarea-2463a3df.js";import{V as Pe}from"./VRow-a7542fa4.js";import{V as Me}from"./VCol-b8625bbb.js";import"./Confirm-6894798d.js";import"./Text-0b0375d7.js";import"./favicon-7b746610.js";const Ue=x("h6",{class:"text-h6 mb-3"},"会话设置",-1),Be=K({__name:"Config",emits:["update:model:info"],setup(i,{expose:M,emit:_}){const C=_,v=me(),{modelName:b}=v.query,c=m(10),p=m(b?{modelName:b}:null),s=ie({maxTokens:512,temperature:0,topP:0}),T=te(()=>{var u;return[{key:"maxTokens",title:"最大响应数",max:((u=p.value)==null?void 0:u.maxTokens)??0,min:0,step:1},{key:"temperature",title:"温度",max:1,min:0,step:.1},{key:"topP",title:"TopP",max:1,min:0,step:.1}]}),S=async g=>{const[u,a]=await ae.get({url:`/api/models/${g.modelName}/info`});if(a){C("update:model:info",a);const n=a.generateConfig;s.maxTokens=s.maxTokens>a.maxTokens?a.maxTokens:512,s.temperature=(n==null?void 0:n.temperature)||0,s.topP=(n==null?void 0:n.top_p)||0}};return M({getData:()=>{var g;return{sendHistoryCount:c.value,data:{model:(g=p.value)==null?void 0:g.modelName,...s}}}}),(g,u)=>(h(),z(E,null,{default:o(()=>[e(q,{class:"mb-2 font-weight-medium"},{default:o(()=>[k("模型")]),_:1}),e(Ve,{modelValue:p.value,"onUpdate:modelValue":[u[0]||(u[0]=a=>p.value=a),S],"default-first-value":"","return-object":""},null,8,["modelValue"]),e(E,null,{default:o(()=>[Ue,e(q,{class:"mb-2 font-weight-medium"},{default:o(()=>[k("包含过去的消息")]),_:1}),e(Q,{modelValue:c.value,"onUpdate:modelValue":u[2]||(u[2]=a=>c.value=a),color:"primary",max:50,min:0,step:"1","hide-details":"","thumb-label":""},{append:o(()=>[e(G,{modelValue:c.value,"onUpdate:modelValue":u[1]||(u[1]=a=>c.value=a),modelModifiers:{number:!0},"hide-details":"","single-line":"",density:"compact",type:"number",max:50,min:0,style:{width:"80px"}},null,8,["modelValue"])]),_:1},8,["modelValue"]),(h(!0),I(P,null,W(T.value,a=>(h(),I(P,null,[e(q,{class:"mb-2 font-weight-medium"},{default:o(()=>[k(H(a.title),1)]),_:2},1024),e(Q,{modelValue:s[a.key],"onUpdate:modelValue":n=>s[a.key]=n,color:"primary",max:a.max,min:a.min,step:a.step,"hide-details":"","thumb-label":""},{append:o(()=>[e(G,{modelValue:s[a.key],"onUpdate:modelValue":n=>s[a.key]=n,modelModifiers:{number:!0},"hide-details":"","single-line":"",density:"compact",type:"number",max:a.max,min:a.min,step:a.step,style:{width:"80px"}},null,8,["modelValue","onUpdate:modelValue","max","min","step"])]),_:2},1032,["modelValue","onUpdate:modelValue","max","min","step"])],64))),256))]),_:1})]),_:1}))}}),Le=i=>(se("data-v-78f12bae"),i=i(),oe(),i),Ne={class:"render-chat border rounded-md h-100 d-flex flex-column"},Re={class:"d-flex align-center justify-space-between pa-3"},Ae={class:"text-h6"},qe={class:"truncate"},ze=Le(()=>x("h4",{class:"text-h6 mb-6"},"配置",-1)),He=K({__name:"RenderChat",props:{systemMessage:{default:""}},emits:["change:model"],setup(i,{expose:M,emit:_}){const C=i,v=_,{scrollRef:b,scrollToBottom:c,scrollToBottomIfAtBottom:p}=de(),s=m([]),T=m(!1),S=m(),U=m({}),g=t=>{U.value=t,v("change:model",t)},u=async({data:t,resolve:f,reject:y})=>{if(T.value){ve.error("请等上个会话生成结束后再试"),y("请等上个会话生成结束后再试");return}let V=t.prompt;const D=a(V);n({content:V,contentType:t.sendType||"text",createdAt:new Date,ext:t.ext,msgType:"question"}),c(),T.value=!0,n({loading:!0,content:"",contentType:"text",createdAt:new Date,msgType:"answer"}),c();try{const[w,B]=await ae.post({url:"/channels/chat/completions",timeout:3e5,data:D,onDownloadProgress:F=>{const re=F.target,{responseText:R}=re,X=R.lastIndexOf(`
`,R.length-2);let Y=R;X!==-1&&(Y=R.substring(X));try{const L=JSON.parse(Y),A=s.value.length-1;if(L.success){const $=L.data;r(A,{loading:!0,content:$.fullContent,contentType:$.contentType??"text",createdAt:$.createdAt,msgType:"answer"})}else{const $=s.value[A];if($.content&&$.content!==""){l(A,{content:`${$.content}
[${L.message}]`,loading:!0});return}r(A,{loading:!0,content:L.message,contentType:"text",createdAt:new Date,msgType:"answer"})}p()}catch{}}});B?f(B):y(w)}catch(w){y(w),console.log(w)}finally{l(s.value.length-1,{loading:!1}),T.value=!1}},a=t=>{const f=S.value.getData(),y=f.data,V=f.sendHistoryCount*2;let D=[];const w=[{role:"system",content:C.systemMessage}];return V!==0&&(D=s.value.slice(-V)),D.forEach(B=>{const F=B.msgType==="question"?"user":"assistant";w.push({role:F,content:B.content})}),w.push({role:"user",content:t}),y.messages=w,y},n=t=>{s.value.push(t)},r=(t,f)=>{s.value[t]=f},l=(t,f)=>{s.value[t]={...s.value[t],...f}};return M({send:t=>_e(new Promise((f,y)=>{u({data:t,resolve:f,reject:y})})),clearChat:()=>{s.value=[]}}),(t,f)=>{const y=pe("perfect-scrollbar");return h(),I("div",Ne,[x("div",Re,[x("h4",Ae,[t.$slots["title-left"]?Z(t.$slots,"title-left",{key:0},void 0,!0):(h(),I(P,{key:1},[k(" 聊天 ")],64))]),e(le,{eager:"","close-on-content-click":!1},{activator:o(({props:V})=>[e(j,fe({class:"menu-model-btn",height:"32"},V,{flat:"",variant:"text"}),{default:o(()=>[x("span",qe,H(U.value.modelName),1),e(J(he),{"stroke-width":"1.5",size:18,class:"ml-1"})]),_:2},1040)]),default:o(()=>[e(E,{class:"pa-4",rounded:"md",width:"350",elevation:"10"},{default:o(()=>[ze,e(Be,{ref_key:"configRef",ref:S,"onUpdate:model:info":g},null,512)]),_:1})]),_:1}),t.$slots["title-right"]?Z(t.$slots,"title-right",{key:0},void 0,!0):O("",!0)]),e(ke),e(y,{ref_key:"scrollRef",ref:b,class:"flex-1"},{default:o(()=>[s.value.length>0?(h(!0),I(P,{key:0},W(s.value,(V,D)=>(h(),z(Ie,{key:D,"chat-item":V},null,8,["chat-item"]))),128)):O("",!0)]),_:1},512)])}}});const Ee=ne(He,[["__scopeId","data-v-78f12bae"]]),Fe=i=>(se("data-v-e029ef98"),i=i(),oe(),i),Je={class:"chat-playground flex",style:{height:"calc(100vh - 180px)"}},Oe={class:"left-part pa-4 d-none d-md-block"},je=Fe(()=>x("h4",{class:"text-h6 mb-6"},"助理设置",-1)),Ke={class:"right-part flex flex-col pa-2"},We={class:"text-right mb-2"},ee=2,Xe=K({__name:"chatPlayground",setup(i){const M=m({title:"聊天操场"}),_=m([{key:Date.now(),comInstance:null}]),C=m(""),v=m(""),b=m(),c=m(""),p=m([]),s=te(()=>_.value.length),T=()=>{s.value!==ee&&_.value.push({key:Date.now(),comInstance:null})},S=({id:r},l)=>{r==="remove"&&_.value.splice(l,1)},U=()=>{const r=C.value;C.value="",_.value.forEach(l=>{l.comInstance&&l.comInstance.send({sendType:"text",prompt:r})})},g=()=>{b.value.show({width:"400px"})},u=()=>{_.value.forEach(r=>{r.comInstance&&r.comInstance.clearChat()}),b.value.hide()},a=(r,l)=>{if(l===0)if(r.fineTuned){const d=r.fineTuned.systemPrompts||[];p.value=d,c.value=d[0],v.value=d[0]}else p.value=[],c.value="",v.value=""},n=r=>{v.value=r};return(r,l)=>(h(),I(P,null,[e(ue,{class:"chat-breadcrumb",title:M.value.title},null,8,["title"]),e($e,{elevation:"10"},{default:o(()=>[x("div",Je,[x("div",Oe,[je,e(E,null,{default:o(()=>[p.value.length>1?(h(),z(Ce,{key:0,class:"mb-3 pt-2",modelValue:c.value,"onUpdate:modelValue":[l[0]||(l[0]=d=>c.value=d),n],clearable:!1,"hide-details":"",items:p.value,label:"请选择系统提示词"},null,8,["modelValue","items"])):O("",!0),e(q,{class:"mb-2 font-weight-medium"},{default:o(()=>[k("系统消息")]),_:1}),e(De,{modelValue:v.value,"onUpdate:modelValue":l[1]||(l[1]=d=>v.value=d),variant:"outlined",placeholder:"可以给定助理角色及相关要求，不要超过2000个字",rows:"5","no-resize":"",color:"primary","row-height":"25",shaped:"","hide-details":""},null,8,["modelValue"])]),_:1})]),x("div",Ke,[x("div",We,[e(j,{size:"small",flat:"",color:"error",variant:"outlined",onClick:T},{default:o(()=>[e(J(ge),{"stroke-width":"1.5",size:18,class:"mr-2"}),k(H(`添加模型(${s.value}/${ee})`),1)]),_:1})]),e(Pe,{class:"overflow-auto",dense:""},{default:o(()=>[(h(!0),I(P,null,W(_.value,(d,N)=>(h(),z(Me,{cols:s.value===1?12:6,class:"h-100",key:d.key},{default:o(()=>[e(Ee,{ref_for:!0,ref:t=>d.comInstance=t,"onChange:model":t=>a(t,N),"system-message":v.value},ye({"title-left":o(()=>[k(H(`#${N+1}`),1)]),_:2},[s.value>1?{name:"title-right",fn:o(()=>[e(j,{size:"x-small",color:"inherit",icon:"",variant:"text"},{default:o(()=>[e(J(xe),{width:"14","stroke-width":"1.5"}),e(le,{activator:"parent"},{default:o(()=>[e(be,{density:"compact","onClick:select":t=>S(t,N)},{default:o(()=>[e(we,{key:"remove",value:"remove","hide-details":"","min-height":"38"},{default:o(()=>[e(Te,null,{default:o(()=>[k("移除")]),_:1})]),_:1})]),_:2},1032,["onClick:select"])]),_:2},1024)]),_:2},1024)]),key:"0"}:void 0]),1032,["onChange:model","system-message"])]),_:2},1032,["cols"]))),128))]),_:1}),e(Se,{modelValue:C.value,"onUpdate:modelValue":l[2]||(l[2]=d=>C.value=d),onSubmit:U,onClear:g},null,8,["modelValue"])])])]),_:1}),e(ce,{ref_key:"refConfirmDelete",ref:b,onSubmit:u},{text:o(()=>[k("确定清空会话？")]),_:1},512)],64))}});const mt=ne(Xe,[["__scopeId","data-v-e029ef98"]]);export{mt as default};
