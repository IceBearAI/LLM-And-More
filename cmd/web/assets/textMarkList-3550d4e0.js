import{_ as Re}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-a832ed83.js";import{_ as Ie}from"./UiParentCard.vue_vue_type_script_setup_true_lang-72749ad5.js";import{d as ie,x as z,z as re,r as f,a9 as Ce,U as b,k as x,l as Q,m as s,W as n,j as a,n as u,_ as l,bB as Z,am as De,an as $e,b9 as v,i as Pe,ad as Me,aE as qe,b8 as Le,o as Ae,S as Fe,Z as C,$ as d,a1 as K,Y as ee,F as Y,bm as Ne,bg as te,Q as Be,a6 as He}from"./utils-91854e55.js";import{_ as je}from"./Explain.vue_vue_type_style_index_0_lang-b72b33af.js";import{R as Ue}from"./RangeSliderWithInput-07141732.js";import{a4 as ae,_ as Ee,V as Ye,d as se,bh as We}from"./index-38e2b3cf.js";import{V as ze}from"./VForm-24c895bc.js";import{A as Qe}from"./AlertBlock-3609563e.js";import{_ as ne}from"./ConfirmByInput.vue_vue_type_style_index_0_lang-01977ff8.js";import{_ as oe}from"./ConfirmByClick.vue_vue_type_style_index_0_lang-888fb4b2.js";import{_ as Ge}from"./DialogLog.vue_vue_type_style_index_0_lang-c273df28.js";import{V as W}from"./VCol-4c3995c3.js";import{V as le}from"./VRow-a4b8abae.js";import{V as Oe}from"./VSlider-3a2354c4.js";import"./VAlert-a7fd619f.js";import"./Confirm-b054f614.js";import"./TextLog-26e3895a.js";const A=D=>(De("data-v-fcb5b176"),D=D(),$e(),D),Xe={class:"mx-auto mt-10",style:{width:"500px"}},Je=A(()=>n("label",{class:"required"},"负责人",-1)),Ze=A(()=>n("label",{class:"required"},"样本名称",-1)),Ke=A(()=>n("label",{class:"required"},"数据序列",-1)),et=A(()=>n("div",{class:"text-gray-400 text-sm mt-2 ml-[44px]"},"数据的随机10%会成为测试集，其余部分会作为训练集",-1)),tt={class:"required"},at=A(()=>n("label",{class:"required"},"任务名称",-1)),st=ie({__name:"PaneTextMarkTask",emits:["submit"],setup(D,{expose:N,emit:$}){const k=z({formData:{name:"",datasetId:"",principal:"",dataSequence:[],annotationType:""},rangeConfig:{min:0,max:0}}),{formData:_,rangeConfig:P}=re(k),M=$,w=f(),V=f(),R=f(),T=z({name:[t=>!!t||"请输入任务名称"],datasetId:[t=>!!t||"请选择样本"],principal:[t=>!!t||"请输入负责人"],annotationType:[t=>!!t||"请选择任务类型"],dataSequence:[()=>{let[t,c]=k.formData.dataSequence;return c>t?!0:"数据序列上限值需大于下限值"}]}),q=({rawData:t})=>{let{rangeConfig:c}=k;t?(Z.scaleIn(R.value),c.max=t.segmentCount):(Z.scaleIn(R.value),c.max=0),k.formData.dataSequence=[c.min,c.max]},L=async(t={})=>{const[c,g]=await v.post({...t,url:"/api/mgr/annotation/task/create",data:{...k.formData}});g&&(w.value.hide(),M("submit"))},F=async({valid:t,showLoading:c})=>{t&&L({showLoading:c})};return N({show({title:t,infos:c={name:"",datasetId:"",principal:"",dataSequence:[0,0],annotationType:""},operateType:g}){w.value.show({title:t,refForm:V}),g=="add"&&(k.formData=Ce.cloneDeep(c))}}),(t,c)=>{const g=b("Select"),B=b("Pane");return x(),Q(B,{ref_key:"refPane",ref:w,class:"",onSubmit:F},{default:s(()=>[n("div",Xe,[a(ze,{ref_key:"refForm",ref:V,class:"my-form"},{default:s(()=>[a(ae,{type:"text",placeholder:"请输入负责人","hide-details":"auto",clearable:"",rules:T.principal,modelValue:u(_).principal,"onUpdate:modelValue":c[0]||(c[0]=y=>u(_).principal=y)},{prepend:s(()=>[Je]),_:1},8,["rules","modelValue"]),a(g,{modelValue:u(_).datasetId,"onUpdate:modelValue":c[1]||(c[1]=y=>u(_).datasetId=y),mapAPI:{url:"/api/mgr/datasets/list",data:{page:1,pageSize:20},labelField:"name",valueField:"uuid",search_keywordField:"name"},"onUpdate:infos":q,rules:T.datasetId},{prepend:s(()=>[Ze]),_:1},8,["modelValue","rules"]),n("div",{ref_key:"refRange",ref:R},[a(Ue,{rules:T.dataSequence,modelValue:u(_).dataSequence,"onUpdate:modelValue":c[2]||(c[2]=y=>u(_).dataSequence=y),min:u(P).min,max:u(P).max},{prepend:s(()=>[Ke]),_:1},8,["rules","modelValue","min","max"]),et],512),a(g,{placeholder:"请选择任务类型",rules:T.annotationType,mapDictionary:{code:"textannotation_type"},modelValue:u(_).annotationType,"onUpdate:modelValue":c[3]||(c[3]=y=>u(_).annotationType=y)},{prepend:s(()=>[n("label",tt,[l("任务类型 "),a(je,null,{default:s(()=>[l("标注完成后，会有两个数据集：同名测试集和训练集")]),_:1})])]),_:1},8,["rules","modelValue"]),a(ae,{type:"text",placeholder:"请输入任务名称","hide-details":"auto",clearable:"",rules:T.name,modelValue:u(_).name,"onUpdate:modelValue":c[4]||(c[4]=y=>u(_).name=y)},{prepend:s(()=>[at]),_:1},8,["rules","modelValue"])]),_:1},512)])]),_:1},512)}}});const nt=Ee(st,[["__scopeId","data-v-fcb5b176"]]),ot={style:{width:"300px"}},lt=["onClick"],it={class:"space-y-2"},rt={class:"link font-bold"},dt={class:"link font-bold"},ct={class:"link font-bold"},ut={key:0,class:"d-flex align-center justify-center"},pt=["onClick"],mt={class:"space-y-2"},ft={class:"link font-bold"},_t={class:"link font-bold"},ht=n("br",null,null,-1),bt=n("span",{class:"text-primary font-weight-black"},"删除",-1),yt=n("br",null,null,-1),gt={class:"text-primary font-weight-black"},xt=n("br",null,null,-1),vt=n("br",null,null,-1),kt=n("span",{class:"text-primary font-weight-black"},"取消",-1),Tt=n("br",null,null,-1),St={class:"text-primary font-weight-black"},wt=n("br",null,null,-1),Vt=n("div",{classs:"text-slate-500"},[l(" 此操作将新建基于该数据集的测试集和训练集，"),n("span",{class:"text-slate-700 font-bold"},"原数据集不会改变。"),l("数据集将会按照以下比例随机切分。 ")],-1),Rt={class:"flex justify-between mt-5 mb-2"},It={class:"text-primary"},Ct={class:"text-primary"},Dt={class:"hv-center"},$t={class:"flex items-center"},Pt=n("div",{class:"mr-4"},"导出格式：",-1),Mt=["innerHTML"],Jt=ie({__name:"textMarkList",setup(D){const N=Pe("provideAspectPage"),{getLabels:$,loadDictTree:k}=Me();k(["textannotation_type"]);const _=qe();Le();const P=f(),M=f(),w=f(),V=f(),R=f(),T=f(),q=f(),L=f(),F=f(),t=z({style:{},formData:{name:"",status:null},tableInfos:{list:[],total:""},selectedRow:{},reportHTML:"",formatTypeSelectedIndex:0,options:{formatType:[{label:"默认",value:"default"},{label:"会话",value:"conversation"}]}}),{style:c,formData:g,options:B}=re(t),y=f({title:"文本标注列表"}),de=f([{text:"任务库",disabled:!1,href:"#"},{text:"文本标注列表",disabled:!0,href:"#"}]),ce=o=>{_.push(`/sample-library/mgr-datasets/list?name=${o}`)},ue=o=>{_.push(`/sample-library/text-mark/detail?annotationId=${o}`)},pe=async()=>{const[o,i]=await v.post({showSuccess:!0,url:`/api/mgr/annotation/task/${t.selectedRow.uuid}/split`,data:{testPercent:t.selectedRow.testPercent/100}});i&&(R.value.hide(),I())},G=o=>`
   <div class="section">
        <div class="title">${o}</div>
        <div class="content">
   `,O=()=>`
        </div>
      </div>
   `,me=o=>{let i=null;try{i=JSON.parse(o)}catch(m){console.log(m)}if(!i)return;let{mismatchedIntents:p,similarIntents:S}=i,h=[],r=[];if(S.length){h.push(G("相似意图"));for(let m of S)for(let U of m.intentPair)h.push(`<div class="item"> ${U}</div>`);h.push(O())}if(p.length){r.push(G("不匹配的意图"));for(let m of p)r.push('<div class="item"> '),m.answer1&&r.push(`<div>问题1：${m.answer1}</div>`),m.answer2&&r.push(`<div>问题2：${m.answer2}</div>`),m.intent1&&r.push(`<div>意图1：${m.intent1}</div>`),m.intent2&&r.push(`<div>意图2：${m.intent2}</div>`),m.lineNumbers.length&&r.push(`<div>问题点：${m.lineNumbers.join("、")}</div>`),r.push("</div>");r.push(O())}return[...h,...r].join("")},fe=async(o={})=>{await v.download({...o,url:`/api/mgr/annotation/task/${t.selectedRow.uuid}/export?formatType=${t.options.formatType[t.formatTypeSelectedIndex].value}`})&&q.value.hide()},_e=o=>{let i=[],{status:p}=o;return["pending","processing"].includes(o.status)&&i.push({text:"标注",click(){ue(o.uuid)}}),["completed"].includes(p)&&(i.push({text:"导出",click(){t.selectedRow=o,q.value.show({width:"500px",title:"导出选择"})}}),o.testTotal===0&&i.push({text:"切分",click(){t.selectedRow=o;let{testTotal:S,trainTotal:h}=o;t.selectedRow.testPercent=Math.floor(h*100/(h+S)),R.value.show({width:"400px"})}}),o.annotationType=="faq"&&((o.detectionStatus==="pending"||o.detectionStatus==="canceled")&&i.push({text:"检测",async click(){const[S,h]=await v.post({timeout:Number.MAX_SAFE_INTEGER,showSuccess:!0,showLoading:!0,url:`/api/mgr/annotation/task/${o.uuid}/detect/annotation/async`});h&&H()}}),o.detectionStatus==="processing"&&i.push({text:"取消检测",async click(){const[S,h]=await v.post({timeout:Number.MAX_SAFE_INTEGER,showSuccess:!0,showLoading:!0,url:`/api/mgr/annotation/task/${o.uuid}/detect/cancel`});h&&H()}}),o.detectionStatus==="completed"&&i.push({text:"标注报告",click(){T.value.show({showActions:!1,contentHeight:"calc(100vh - 400px)"}),t.reportHTML=me(o.testReport)}}))),["processing"].includes(p)&&i.push({text:"取消",color:"error",click(){ye(o)}}),["completed","cleaned","abandoned","pending"].includes(p)&&i.push({text:"删除",color:"error",click(){he(o)}}),i},I=async(o={})=>{const[i,p]=await v.get({url:"/api/mgr/annotation/task/list",showLoading:V.value.el,data:{...t.formData,...o}});p?(t.tableInfos.list=p.list||[],t.tableInfos.total=p.total):(t.tableInfos.list=[],t.tableInfos.total=0),F.value.start()};N.methods.refreshListPage=()=>{I()};const X=()=>{V.value.query({page:1})},H=()=>{V.value.query()},he=o=>{t.selectedRow=o,M.value.show({width:"600px",confirmText:t.selectedRow.uuid})},be=async(o={})=>{const[i,p]=await v.delete({...o,showSuccess:!0,url:`/api/mgr/annotation/task/${t.selectedRow.uuid}/delete`});p&&(M.value.hide(),I())},J=o=>({pending:"undo",processing:"doing",completed:"done",abandoned:"status-gray",cleaned:"status-gray",canceled:"status-gray"})[o],ye=o=>{t.selectedRow=o,w.value.show({width:"600px",confirmText:t.selectedRow.uuid})},ge=async(o={})=>{const[i,p]=await v.put({...o,showSuccess:!0,url:`/api/mgr/annotation/task/${t.selectedRow.uuid}/clean`});p&&(w.value.hide(),I())},xe=()=>{P.value.show({title:"创建文本标注任务",operateType:"add"})},ve=async o=>{t.selectedRow=o,L.value.show()},ke=async()=>{let[o,i]=await v.get({url:`/api/mgr/annotation/task/${t.selectedRow.uuid}/detect/annotation/log`});if(i){const p=Object.keys(i).length===0?"":i;L.value.setContent(p)}};return Ae(()=>{I()}),(o,i)=>{const p=b("Select"),S=b("refresh-button"),h=b("ButtonsInForm"),r=b("el-table-column"),j=b("el-tooltip"),m=b("el-popover"),U=b("router-link"),Te=b("ButtonsInTable"),Se=b("TableWithPager"),we=b("Dialog"),Ve=Fe("copy");return x(),C(Y,null,[a(Re,{title:y.value.title,breadcrumbs:de.value},null,8,["title","breadcrumbs"]),a(le,null,{default:s(()=>[a(W,null,{default:s(()=>[a(Ie,null,{default:s(()=>[a(le,null,{default:s(()=>[a(W,{cols:"12",class:"flex justify-between"},{default:s(()=>[n("div",ot,[a(p,{onChange:X,label:"请选择标注状态",mapDictionary:{code:"local_mark_status"},modelValue:u(g).status,"onUpdate:modelValue":i[0]||(i[0]=e=>u(g).status=e)},null,8,["modelValue"])]),a(h,null,{default:s(()=>[a(Ye,{color:"primary",onClick:i[1]||(i[1]=e=>xe())},{default:s(()=>[l("创建文本标注任务")]),_:1}),a(S,{ref_key:"refreshButtonRef",ref:F,onRefresh:H},null,512)]),_:1})]),_:1}),a(W,{cols:"12"},{default:s(()=>[a(Se,{onQuery:I,ref_key:"refTableWithPager",ref:V,infos:t.tableInfos},{default:s(()=>[a(r,{label:"任务名称",width:"200px",fixed:"left"},{default:s(({row:e})=>[l(d(e.name),1)]),_:1}),a(r,{label:"数据集名称",width:"200px"},{default:s(({row:e})=>[a(j,{content:"查看数据集"},{default:s(()=>[n("a",{class:"link",onClick:E=>ce(e.datasetName)},d(e.datasetName),9,lt)]),_:2},1024)]),_:1}),a(r,{label:"数据序列",width:"100px"},{default:s(({row:e})=>[l(d(e.dataSequence.join(" ~ ")),1)]),_:1}),a(r,{label:"任务类型",width:"120px"},{default:s(({row:e})=>[l(d(u($)([["textannotation_type",e.annotationType]])),1)]),_:1}),a(r,{width:"120px"},{header:s(()=>[l("完成进度")]),default:s(({row:e})=>[a(m,{placement:"right"},{reference:s(()=>[l(d(e.completed)+" / "+d(e.total-e.completed-e.abandoned)+" / "+d(e.abandoned),1)]),default:s(()=>[n("div",it,[n("div",null,[l(" 已完成："),n("span",rt,d(e.completed),1)]),n("div",null,[l(" 未完成："),n("span",dt,d(e.total-e.completed-e.abandoned),1)]),n("div",null,[l(" 丢弃："),n("span",ct,d(e.abandoned),1)])])]),_:2},1024)]),_:1}),a(r,{label:"状态",width:"120px"},{default:s(({row:e})=>[a(se,{label:"",size:"small",class:K(J(e.status))},{default:s(()=>[l(d(u($)([["local_mark_status",e.status]])),1)]),_:2},1032,["class"])]),_:1}),a(r,{label:"检测状态",width:"135px"},{default:s(({row:e})=>[e.annotationType=="faq"&&e.status!=="processing"?(x(),C("div",ut,[n("span",{class:K(J(e.detectionStatus))},d(u($)([["local_mark_detect_status",e.detectionStatus]])),3),["processing","completed"].includes(e.detectionStatus)?(x(),C("div",{key:0,class:"link ml-1",onClick:E=>ve(e)}," (日志) ",8,pt)):ee("",!0)])):(x(),C(Y,{key:1},[l(" -- ")],64))]),_:1}),a(r,{label:"webshell","min-width":"90px"},{default:s(({row:e})=>[e.detectionStatus==="processing"?(x(),Q(j,{key:0,content:"进入终端",placement:"top"},{default:s(()=>[a(U,{class:"link",to:{path:"/model/terminal",query:{resourceType:"datasets-eval",serviceName:e.jobName}},target:"_blank"},{default:s(()=>[a(u(Ne),{class:"align-top",size:20})]),_:2},1032,["to"])]),_:2},1024)):ee("",!0)]),_:1}),a(r,{label:"完成时间","min-width":"180px"},{default:s(({row:e})=>[l(d(u(te).dateFormat(e.completedAt,"YYYY-MM-DD HH:mm:ss")),1)]),_:1}),a(r,{label:"创建时间","min-width":"180px"},{default:s(({row:e})=>[l(d(u(te).dateFormat(e.createdAt,"YYYY-MM-DD HH:mm:ss")),1)]),_:1}),a(r,{label:"训练集数量","min-width":"120px"},{default:s(({row:e})=>[a(m,{placement:"right"},{reference:s(()=>[l(d(e.testTotal)+" / "+d(e.trainTotal),1)]),default:s(()=>[n("div",mt,[n("div",null,[l(" 测试集数量："),n("span",ft,d(e.testTotal),1)]),n("div",null,[l(" 训练集数量："),n("span",_t,d(e.trainTotal),1)])])]),_:2},1024)]),_:1}),a(r,{label:"负责人",width:"200px"},{default:s(({row:e})=>[Be((x(),C("span",null,[l(d(e.principal),1)])),[[Ve,e.principal]])]),_:1}),a(r,{label:"操作","min-width":"120px",fixed:"right"},{default:s(({row:e})=>[a(Te,{buttons:_e(e)},null,8,["buttons"])]),_:1})]),_:1},8,["infos"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(nt,{ref_key:"refPaneTextMarkTask",ref:P,onSubmit:X},null,512),a(ne,{ref_key:"refConfirmDelete",ref:M,onSubmit:be},{text:s(()=>[l(" 这是进行一项操作时必须了解的重要信息"),ht,l(" 此操作将会"),bt,l("在进行的标注任务"),yt,l(" 数据集ID："),n("span",gt,d(t.selectedRow.uuid),1),xt,l("你还要继续吗？ ")]),_:1},512),a(ne,{ref_key:"refConfirmCancel",ref:w,onSubmit:ge},{text:s(()=>[l(" 这是进行一项操作时必须了解的重要信息"),vt,l(" 此操作将会"),kt,l("尚未开始的标注任务"),Tt,l(" 数据集ID："),n("span",St,d(t.selectedRow.uuid),1),wt,l("你还要继续吗？ ")]),_:1},512),a(oe,{ref_key:"refConfirmSplit",ref:R,onSubmit:pe},{text:s(()=>[Vt,n("div",null,[n("div",Rt,[n("div",null,[l(" 训练集 "),n("span",It,d(t.selectedRow.testPercent)+"%",1)]),n("div",null,[l(" 测试集 "),n("span",Ct,d(100-t.selectedRow.testPercent)+"%",1)])]),a(Oe,{color:"primary",step:"1",modelValue:t.selectedRow.testPercent,"onUpdate:modelValue":i[2]||(i[2]=e=>t.selectedRow.testPercent=e)},null,8,["modelValue"])])]),_:1},512),a(oe,{ref_key:"refConfirmDownload",ref:q,onSubmit:fe},{text:s(()=>[a(Qe,{class:"mb-6"},{default:s(()=>[l(" 该操作将直接生成训练数据集，导出的数据将会以jsonl的格式导出。 ")]),_:1}),n("div",Dt,[n("div",$t,[Pt,a(We,{mandatory:"","selected-class":"text-primary",modelValue:t.formatTypeSelectedIndex,"onUpdate:modelValue":i[3]||(i[3]=e=>t.formatTypeSelectedIndex=e)},{default:s(()=>[(x(!0),C(Y,null,He(u(B).formatType,(e,E)=>(x(),Q(se,{key:E,filter:"",variant:"outlined"},{default:s(()=>[l(d(e.label),1)]),_:2},1024))),128))]),_:1},8,["modelValue"])])])]),_:1},512),a(Ge,{ref_key:"refDialogLog",ref:L,interval:20,onRefresh:ke},null,512),a(we,{ref_key:"refReport",ref:T,style:{width:"80%","max-width":"800px"}},{title:s(()=>[l("标注数据检测报告")]),default:s(()=>[n("div",{class:"box-report",innerHTML:t.reportHTML},null,8,Mt)]),_:1},512)],64)}}});export{Jt as default};
