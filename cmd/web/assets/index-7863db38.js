import{_ as ce}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-77b9c177.js";import{_ as z}from"./UiParentCard.vue_vue_type_script_setup_true_lang-f6f68ebc.js";import{_ as X}from"./AiAudio.vue_vue_type_style_index_0_lang-0cb907a9.js";import{d as M,r as p,x as J,z as ie,c as H,k as y,l as de,m as c,j as o,a0 as q,n as K,av as ue,o as fe,aw as I,a1 as k,Q as C,a3 as F,Z as w,F as Q,W as i,$ as W,P as Z,al as pe,am as me,ax as B,K as _e,_ as D}from"./utils-7a539270.js";import{V as L}from"./VCol-b16873ba.js";import{V as ve}from"./VFileInput-185dd17d.js";import{V as j}from"./VRow-220780f3.js";import{c as he,_ as G}from"./index-de28ea06.js";import{V as ye,a as O,b as ge,c as P}from"./VWindowItem-1bea28f1.js";var xe=he("microphone","IconMicrophone",[["path",{d:"M9 2m0 3a3 3 0 0 1 3 -3h0a3 3 0 0 1 3 3v5a3 3 0 0 1 -3 3h0a3 3 0 0 1 -3 -3z",key:"svg-0"}],["path",{d:"M5 10a7 7 0 0 0 14 0",key:"svg-1"}],["path",{d:"M8 21l8 0",key:"svg-2"}],["path",{d:"M12 17l0 4",key:"svg-3"}]]);const we=M({__name:"TabFile",emits:["translate"],setup(g,{expose:_,emit:v}){const d=p(),r=p(),e=J({style:{isLoading:!1},formData:{},audioFile:[]}),{style:m,formData:S}=ie(e),h=v,u=H(()=>{let{audioFile:a}=e;return a&&a.length>0?URL.createObjectURL(a[0]):""}),x=async()=>{if(!u)return;e.style.isLoading=!0;const[a,l]=await ue.upload({url:"/voice/translation",showLoading:d.value.$el,data:{file:e.audioFile[0]}});e.style.isLoading=!1,l&&h("translate",l.data.text)};return _({reset(){e.style.isLoading=!1,r.value.pause(),e.audioFile=[]}}),(a,l)=>(y(),de(j,{ref_key:"refBox",ref:d,class:"justify-center py-4"},{default:c(()=>[o(L,{cols:"12",class:q(["h-center",{"opacity-0":K(m).isLoading}])},{default:c(()=>[o(X,{ref_key:"refAiAudio",ref:r,src:u.value,type:"complex"},null,8,["src"])]),_:1},8,["class"]),o(L,{cols:"12",md:"6",class:"mt-5"},{default:c(()=>[o(ve,{modelValue:e.audioFile,"onUpdate:modelValue":l[0]||(l[0]=s=>e.audioFile=s),accept:"audio/*, .mp3, .wma, .amr, .wav, .m4a",label:"请选择音频","prepend-icon":"mdi-volume-high","hide-details":"",variant:"outlined",onChange:x},null,8,["modelValue"])]),_:1})]),_:1},512))}}),be=g=>(pe("data-v-4c86e258"),g=g(),me(),g),Re={style:{"min-height":"390px"}},Ve={class:"w-100"},ke={class:"d-flex tab-voice"},Se={class:"flex-1 text-h2 overflow-hidden d-flex justify-end align-center mr-10",style:{"margin-left":"-40px"}},Te=be(()=>i("div",{class:"flex-1"},null,-1)),Ie={class:"shower-momentWords text-center"},$e={class:"line1"},Ue={class:"h-center mt-10"},Ae={key:1},Ce=M({__name:"TabVoice",emits:["translate","voiceStart","voiceEnd"],setup(g,{expose:_,emit:v}){const d=p(),r=p(),e=J({statusRecord:"idle",statusText:"",momentWords:"",videoUrl:"",isReady:""}),m=v,S=()=>{let{statusRecord:t}=e;t=="idle"?N():t=="recording"?U():t=="error"&&N()},h=t=>{try{let f=JSON.parse(t.data).text;m("translate",f),e.momentWords=f,console.log("getJsonMessage ============== "+JSON.parse(t.data).text)}catch{k.error("实时语音异常"),console.log("getJsonMessage error",t)}};let u,x;var a=new Int16Array;let l,s;const n=()=>{var t=new Array(5,10,5),f={chunk_size:t,wav_name:"h5",is_speaking:!1,chunk_interval:10,mode:"online"};a.length>0&&(l.wsSend(a),console.log("sampleBuf.length"+a.length),a=new Int16Array),l.wsSend(JSON.stringify(f)),setTimeout(function(){console.log("call stop ws!"),l.wsStop()},0),s.stop(function(R,E){console.log("stop record",R),u.pcm2wav({sampleRate:16e3,bitRate:16,blob:R},function(V,oe){console.log(V),e.videoUrl=(window.URL||webkitURL).createObjectURL(V),e.momentWords=""},function(V){console.log(V)})},function(R){console.log("stop record , errMsg: "+R)})},b=(t,f,R,E,V,oe)=>{console.log("rec process ... ");var ae=t[t.length-1],re=new Array(ae),ne=u.SampleData(re,E,16e3).data;a=Int16Array.from([...a,...ne]);for(var A=960;a.length>=A;){let le=a.slice(0,A);a=a.slice(A,a.length),l.wsSend(le)}},N=()=>{e.statusRecord="connecting",T("正在等待..."),l=new x({msgHandle:h,stateHandle:Y,toast:k});var t=l.wsStart();t=="broswerNotSupport"&&(U(),k.error("当前浏览器不支持 WebSocket"))},Y=t=>{console.log("getConnState  ",t),t==="ws-success"?ee():t==="ws-close"||t==="ws-error"&&$()},ee=()=>{e.videoUrl="",s.open(function(){s.start(),m("voiceStart"),e.statusRecord="recording",T("正在听取...")},t=>{k.error(t),$()})},$=()=>{e.statusRecord="error",T("点击重试"),m("voiceEnd"),n()},U=()=>{e.statusRecord="idle",T(""),m("voiceEnd"),e.momentWords="",n()},T=t=>{t!=e.statusText&&(e.statusText=t,Z(()=>{d.value&&B(d.value,[{transform:"translateX(60px)",opacity:0},{transform:"translateX(15px)",opacity:.2},{transform:"translateX(0px)",opacity:1}],{duration:500,fill:"forwards"})}))},te=()=>{let{statusRecord:t}=e;return t},se=()=>{u=window.Recorder,x=window.WebSocketConnectMethod,s=u({type:"pcm",bitRate:16,sampleRate:16e3,onProcess:b}),e.isReady=!0};return fe(async()=>{let{origin:t}=location;I.asyncImportJavaScript(`${t}/assets/js/asr/recorder-core.js`).then(()=>{Promise.all([I.asyncImportJavaScript(`${t}/assets/js/asr/wav.js`),I.asyncImportJavaScript(`${t}/assets/js/asr/pcm.js`),I.asyncImportJavaScript(`${t}/assets/js/asr/wsconnecter.js`)]).then(()=>{se()}).catch(f=>{console.error(f),k.error("初始化失败，请检查"),e.isReady=!1})})}),_({reset(){r.value.pause(),e.videoUrl="",["connecting","recording"].includes(e.statusRecord)?U():e.statusRecord=="error"&&$()}}),(t,f)=>C((y(),w("div",Re,[e.isReady?(y(),w(Q,{key:0},[i("div",Ve,[i("div",ke,[i("div",Se,[i("div",{ref_key:"refRecordShowText",ref:d,class:"text-medium-emphasis"},W(e.statusText),513)]),i("div",{class:q(["btn-record cursor-pointer",te()]),onClick:S},[o(K(xe),{class:"icon-record d-block",size:80,strokeWidth:"2"})],2),Te])]),C(i("div",Ie,[i("p",$e,W(e.momentWords),1)],512),[[F,e.momentWords]]),C(i("div",Ue,[o(X,{ref_key:"refAiAudio",ref:r,src:e.videoUrl,type:"complex"},null,8,["src"])],512),[[F,e.videoUrl]])],64)):(y(),w("div",Ae))],512)),[[F,e.isReady!==""]])}});const Fe=G(Ce,[["__scopeId","data-v-4c86e258"]]),We={style:{"min-height":"300px"}},Be={style:{"min-height":"300px"}},Le=["textContent"],je={key:1,class:"flex-fill text-center"},Me=M({__name:"index",setup(g){const _=p(),v=p(),d=p(),r=J({tabIndex:"tabVoice",result:"",statusVoice:""}),e=p({title:"声音转文本"}),m=p([{text:"语音服务",disabled:!1,href:"#"},{text:"声音转文本",disabled:!0,href:"#"}]),S=s=>{console.log("onVoice",s),r.result+=s},h=s=>{if(s==r.result)return;let{finished:n}=B(_.value.$el,[{opacity:.7,transform:"scale(1.02)"},{opacity:0,transform:"scale(1.05)"}],{duration:300,fill:"forwards"});n.then(()=>{r.result=s||"",Z(()=>{B(_.value.$el,[{opacity:.2,transform:"none"},{opacity:1,transform:"none"}],{duration:600,fill:"forwards"})})})},u=H(()=>{let{statusVoice:s,result:n}=r;return s=="working"?!0:!!n}),x=()=>{r.statusVoice="working",h("")},a=()=>{r.statusVoice=""},l=()=>{var s,n;(s=v.value)==null||s.reset(),(n=d.value)==null||n.reset(),h("")};return _e(()=>{var s,n;(s=v.value)==null||s.reset(),(n=d.value)==null||n.reset()}),(s,n)=>(y(),w(Q,null,[o(ce,{title:e.value.title,breadcrumbs:m.value},null,8,["title","breadcrumbs"]),o(z,null,{default:c(()=>[o(ye,{modelValue:r.tabIndex,"onUpdate:modelValue":[n[0]||(n[0]=b=>r.tabIndex=b),l],color:"primary"},{default:c(()=>[o(O,{value:"tabVoice",class:"text-h5"},{default:c(()=>[D("实时语音转换")]),_:1}),o(O,{value:"tabFile",class:"text-h5"},{default:c(()=>[D("上传音频文件")]),_:1})]),_:1},8,["modelValue"]),o(ge,{modelValue:r.tabIndex,"onUpdate:modelValue":n[1]||(n[1]=b=>r.tabIndex=b),class:"py-6"},{default:c(()=>[o(P,{value:"tabVoice"},{default:c(()=>[i("div",We,[o(Fe,{ref_key:"refTabVoice",ref:v,onVoiceStart:x,onVoiceEnd:a,onTranslate:S},null,512)])]),_:1}),o(P,{value:"tabFile"},{default:c(()=>[i("div",Be,[o(we,{ref_key:"refTabFile",ref:d,onTranslate:h},null,512)])]),_:1})]),_:1},8,["modelValue"]),o(j,null,{default:c(()=>[o(L,{cols:"12"},{default:c(()=>[o(z,{title:"转换结果"},{default:c(()=>[o(j,{ref_key:"refResult",ref:_,class:"text-body-1 pa-5 scrollbar-auto shower-result"},{default:c(()=>[u.value?(y(),w("p",{key:0,textContent:W(r.result),style:{"white-space":"pre-wrap"}},null,8,Le)):(y(),w("p",je,"暂无结果"))]),_:1},512)]),_:1})]),_:1})]),_:1})]),_:1})],64))}});const qe=G(Me,[["__scopeId","data-v-fc431b61"]]);export{qe as default};
