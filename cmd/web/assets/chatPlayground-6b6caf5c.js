import{_ as ne}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-6c45f033.js";import{_ as re}from"./ConfirmByClick.vue_vue_type_style_index_0_lang-58ada805.js";import{u as ue}from"./useScroll-b847ceae.js";import{d as j,b8 as ce,r as d,x as de,c as te,k as f,l as z,m as o,j as e,_ as x,Z as $,a6 as K,F as D,$ as E,b9 as ae,U as me,W as w,X as Z,L as ie,n as F,bq as pe,Y as J,br as fe,a2 as he,bs as ve,V as _e,aC as ye,am as ge,an as xe}from"./utils-5e900427.js";import{_ as Ve}from"./ModelSelect.vue_vue_type_script_setup_true_lang-165cd9ec.js";import{a3 as A,a4 as G,V as O,J as se,K as ke,_ as oe,ag as Ce,H as be,h as we,e as Te,$ as Ie}from"./index-81f01cfc.js";import{V as Q}from"./VSlider-7d8ee13e.js";import{V as W}from"./VSheet-dda4148b.js";import{M as $e,S as Pe}from"./SendMsg-c46afa28.js";import{V as Se}from"./VTextarea-0c99cd02.js";import{V as De}from"./VRow-1ab8c2e6.js";import{V as Me}from"./VCol-8780c689.js";import"./Confirm-298ef43f.js";import"./Text-c4d7669a.js";import"./favicon-7b746610.js";const Ue=j({__name:"Config",emits:["update:model:info"],setup(T,{expose:M,emit:h}){const V=h,v=ce(),{modelName:k}=v.query,u=d(20),i=d(k?{modelName:k}:null),s=de({maxTokens:512,temperature:0,topP:0,frequencyPenalty:0,presencePenalty:0}),C=te(()=>{var r;return[{key:"maxTokens",title:"最大响应数",max:((r=i.value)==null?void 0:r.maxTokens)??0,min:0,step:1},{key:"temperature",title:"温度",max:1,min:0,step:.1},{key:"topP",title:"TopP",max:1,min:0,step:.1},{key:"frequencyPenalty",title:"频率惩罚",max:1,min:0,step:.1},{key:"presencePenalty",title:"重复惩罚",max:1,min:0,step:.1}]}),P=async _=>{const[r,a]=await ae.get({url:`/api/models/${_.modelName}/info`});if(a){V("update:model:info",a);const m=a.generateConfig;s.maxTokens=s.maxTokens>a.maxTokens?a.maxTokens:512,C.value.forEach(l=>{l.key!=="maxTokens"&&(s[l.key]=(m==null?void 0:m[l.key])||0)})}};return M({getData:()=>{var _;return{sendHistoryCount:u.value,data:{model:(_=i.value)==null?void 0:_.modelName,...s}}}}),(_,r)=>(f(),z(W,null,{default:o(()=>[e(A,{class:"mb-2 font-weight-medium"},{default:o(()=>[x("模型")]),_:1}),e(Ve,{class:"mb-2",modelValue:i.value,"onUpdate:modelValue":[r[0]||(r[0]=a=>i.value=a),P],"default-first-value":"","return-object":"","hide-details":""},null,8,["modelValue"]),e(A,{class:"mb-2 font-weight-medium"},{default:o(()=>[x("包含过去的消息")]),_:1}),e(Q,{modelValue:u.value,"onUpdate:modelValue":r[2]||(r[2]=a=>u.value=a),color:"primary",max:50,min:0,step:"1","hide-details":"","thumb-label":""},{append:o(()=>[e(G,{modelValue:u.value,"onUpdate:modelValue":r[1]||(r[1]=a=>u.value=a),modelModifiers:{number:!0},"hide-details":"","single-line":"",density:"compact",type:"number",max:50,min:0,style:{width:"80px"}},null,8,["modelValue"])]),_:1},8,["modelValue"]),(f(!0),$(D,null,K(C.value,a=>(f(),$(D,null,[e(A,{class:"mb-2 font-weight-medium"},{default:o(()=>[x(E(a.title),1)]),_:2},1024),e(Q,{modelValue:s[a.key],"onUpdate:modelValue":m=>s[a.key]=m,color:"primary",max:a.max,min:a.min,step:a.step,"hide-details":"","thumb-label":""},{append:o(()=>[e(G,{modelValue:s[a.key],"onUpdate:modelValue":m=>s[a.key]=m,modelModifiers:{number:!0},"hide-details":"","single-line":"",density:"compact",type:"number",max:a.max,min:a.min,step:a.step,style:{width:"80px"}},null,8,["modelValue","onUpdate:modelValue","max","min","step"])]),_:2},1032,["modelValue","onUpdate:modelValue","max","min","step"])],64))),256))]),_:1}))}}),Le={class:"render-chat border rounded-md h-100 d-flex flex-column"},Ne={class:"d-flex align-center justify-space-between pa-3"},Re={class:"text-h6"},Be={class:"truncate"},qe=j({__name:"RenderChat",props:{systemMessage:{default:""}},emits:["change:model"],setup(T,{expose:M,emit:h}){const V=T,v=h,{scrollRef:k,scrollToBottom:u,scrollToBottomIfAtBottom:i}=ue(),s=d([]),C=d(!1),P=d(),U=d({}),_=t=>{U.value=t,v("change:model",t)},r=async({data:t,resolve:p,reject:y})=>{if(C.value){he.error("请等上个会话生成结束后再试"),y("请等上个会话生成结束后再试");return}let g=t.prompt;const S=a(g);m({content:g,contentType:t.sendType||"text",createdAt:new Date,ext:t.ext,msgType:"question"}),u(),C.value=!0,m({loading:!0,content:"",contentType:"text",createdAt:new Date,msgType:"answer"}),u();try{const[b,L]=await ae.post({url:"/channels/chat/completions",timeout:3e5,data:S,onDownloadProgress:H=>{const le=H.target,{responseText:B}=le,X=B.lastIndexOf(`
`,B.length-2);let Y=B;X!==-1&&(Y=B.substring(X));try{const N=JSON.parse(Y),q=s.value.length-1;if(N.success){const I=N.data;l(q,{loading:!0,content:I.fullContent,contentType:I.contentType??"text",createdAt:I.createdAt,msgType:"answer"})}else{const I=s.value[q];if(I.content&&I.content!==""){n(q,{content:`${I.content}
[${N.message}]`,loading:!0});return}l(q,{loading:!0,content:N.message,contentType:"text",createdAt:new Date,msgType:"answer"})}i()}catch{}}});L?p(L):y(b)}catch(b){y(b),console.log(b)}finally{n(s.value.length-1,{loading:!1}),C.value=!1}},a=t=>{const p=P.value.getData(),y=p.data,g=p.sendHistoryCount*2;let S=[];const b=[{role:"system",content:V.systemMessage}];return g!==0&&(S=s.value.slice(-g)),S.forEach(L=>{const H=L.msgType==="question"?"user":"assistant";b.push({role:H,content:L.content})}),b.push({role:"user",content:t}),y.messages=b,y},m=t=>{s.value.push(t)},l=(t,p)=>{s.value[t]=p},n=(t,p)=>{s.value[t]={...s.value[t],...p}};return M({send:t=>fe(new Promise((p,y)=>{r({data:t,resolve:p,reject:y})})),clearChat:()=>{s.value=[]}}),(t,p)=>{const y=me("perfect-scrollbar");return f(),$("div",Le,[w("div",Ne,[w("h4",Re,[t.$slots["title-left"]?Z(t.$slots,"title-left",{key:0},void 0,!0):(f(),$(D,{key:1},[x(" 聊天 ")],64))]),e(se,{eager:"","close-on-content-click":!1},{activator:o(({props:g})=>[e(O,ie({class:"menu-model-btn",height:"32"},g,{flat:"",variant:"text"}),{default:o(()=>[w("span",Be,E(U.value.modelName),1),e(F(pe),{"stroke-width":"1.5",size:18,class:"ml-1"})]),_:2},1040)]),default:o(()=>[e(W,{class:"pa-4",rounded:"md",width:"350",elevation:"10"},{default:o(()=>[e(Ue,{ref_key:"configRef",ref:P,"onUpdate:model:info":_},null,512)]),_:1})]),_:1}),t.$slots["title-right"]?Z(t.$slots,"title-right",{key:0},void 0,!0):J("",!0)]),e(ke),e(y,{ref_key:"scrollRef",ref:k,class:"flex-1"},{default:o(()=>[s.value.length>0?(f(!0),$(D,{key:0},K(s.value,(g,S)=>(f(),z($e,{key:S,"chat-item":g},null,8,["chat-item"]))),128)):J("",!0)]),_:1},512)])}}});const Ae=oe(qe,[["__scopeId","data-v-3fa3b103"]]),ze=T=>(ge("data-v-e029ef98"),T=T(),xe(),T),Ee={class:"chat-playground flex",style:{height:"calc(100vh - 180px)"}},He={class:"left-part pa-4 d-none d-md-block"},Fe=ze(()=>w("h4",{class:"text-h6 mb-6"},"助理设置",-1)),Je={class:"right-part flex flex-col pa-2"},Oe={class:"text-right mb-2"},ee=2,je=j({__name:"chatPlayground",setup(T){const M=d({title:"聊天操场"}),h=d([{key:Date.now(),comInstance:null}]),V=d(""),v=d(""),k=d(),u=d(""),i=d([]),s=te(()=>h.value.length),C=()=>{s.value!==ee&&h.value.push({key:Date.now(),comInstance:null})},P=({id:l},n)=>{l==="remove"&&h.value.splice(n,1)},U=()=>{const l=V.value;V.value="",h.value.forEach(n=>{n.comInstance&&n.comInstance.send({sendType:"text",prompt:l})})},_=()=>{k.value.show({width:"400px"})},r=()=>{h.value.forEach(l=>{l.comInstance&&l.comInstance.clearChat()}),k.value.hide()},a=(l,n)=>{if(n===0)if(l.fineTuned){const c=l.fineTuned.systemPrompts||[];i.value=c,u.value=c[0],v.value=c[0]}else i.value=[],u.value="",v.value=""},m=l=>{v.value=l};return(l,n)=>(f(),$(D,null,[e(ne,{class:"chat-breadcrumb",title:M.value.title},null,8,["title"]),e(Ie,{elevation:"10"},{default:o(()=>[w("div",Ee,[w("div",He,[Fe,e(W,null,{default:o(()=>[i.value.length>1?(f(),z(Ce,{key:0,class:"mb-3 pt-2",modelValue:u.value,"onUpdate:modelValue":[n[0]||(n[0]=c=>u.value=c),m],clearable:!1,"hide-details":"",items:i.value,label:"请选择系统提示词"},null,8,["modelValue","items"])):J("",!0),e(A,{class:"mb-2 font-weight-medium"},{default:o(()=>[x("系统消息")]),_:1}),e(Se,{modelValue:v.value,"onUpdate:modelValue":n[1]||(n[1]=c=>v.value=c),variant:"outlined",placeholder:"可以给定助理角色及相关要求，不要超过2000个字",rows:"5","no-resize":"",color:"primary","row-height":"25",shaped:"","hide-details":""},null,8,["modelValue"])]),_:1})]),w("div",Je,[w("div",Oe,[e(O,{size:"small",flat:"",color:"error",variant:"outlined",onClick:C},{default:o(()=>[e(F(ve),{"stroke-width":"1.5",size:18,class:"mr-2"}),x(E(`添加模型(${s.value}/${ee})`),1)]),_:1})]),e(De,{class:"overflow-auto",dense:""},{default:o(()=>[(f(!0),$(D,null,K(h.value,(c,R)=>(f(),z(Me,{cols:s.value===1?12:6,class:"h-100",key:c.key},{default:o(()=>[e(Ae,{ref_for:!0,ref:t=>c.comInstance=t,"onChange:model":t=>a(t,R),"system-message":v.value},_e({"title-left":o(()=>[x(E(`#${R+1}`),1)]),_:2},[s.value>1?{name:"title-right",fn:o(()=>[e(O,{size:"x-small",color:"inherit",icon:"",variant:"text"},{default:o(()=>[e(F(ye),{width:"14","stroke-width":"1.5"}),e(se,{activator:"parent"},{default:o(()=>[e(be,{density:"compact","onClick:select":t=>P(t,R)},{default:o(()=>[e(we,{key:"remove",value:"remove","hide-details":"","min-height":"38"},{default:o(()=>[e(Te,null,{default:o(()=>[x("移除")]),_:1})]),_:1})]),_:2},1032,["onClick:select"])]),_:2},1024)]),_:2},1024)]),key:"0"}:void 0]),1032,["onChange:model","system-message"])]),_:2},1032,["cols"]))),128))]),_:1}),e(Pe,{modelValue:V.value,"onUpdate:modelValue":n[2]||(n[2]=c=>V.value=c),onSubmit:U,onClear:_},null,8,["modelValue"])])])]),_:1}),e(re,{ref_key:"refConfirmDelete",ref:k,onSubmit:r},{text:o(()=>[x("确定清空会话？")]),_:1},512)],64))}});const ut=oe(je,[["__scopeId","data-v-e029ef98"]]);export{ut as default};
